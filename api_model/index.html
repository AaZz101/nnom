<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Model - NNoM Documentation</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Model";
    var mkdocs_page_input_path = "api_model.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-141541198-1', 'majianjia.github.io/nnom');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> NNoM Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Overview</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Guides</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../guide_5_min_to_nnom/">5 min to NNoM</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../guide_development/">Development Guide</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Porting_and_Optimisation_Guide/">Porting and Optimisation Guide</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">APIs</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../api_nnom_utils/">Utils</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../api_nnom/">Utils (>0.4.0)</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Model</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#new_model">new_model()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#model_delete">model_delete()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sequencial_compile">sequencial_compile()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#model_compile">model_compile()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#model_run">model_run()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#model_run_to">model_run_to()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#layer_callback">(*layer_callback)()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#model_set_callback">model_set_callback()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#model_delete_callback">model_delete_callback()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#examples">Examples</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../api_construction/">Construction Methods</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../api_properties/">Properties</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../api_tensor/">Tensors</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../api_layers/">Core Layers</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../api_pooling/">Pooling Layers</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../api_activations/">Activations</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../api_merge/">Merges Layers</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../api_evaluation/">Evaluation Methods</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Legacy Guide</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../A_Temporary_Guide_to_NNoM/">A Temporary Guide</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../legacy_README/">Old Readme</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Chinese (中文)</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../rt-thread_guide/">RT-Thread</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../example_mnist_simple_cn/">MNIST-Simple</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">NNoM Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>APIs &raquo;</li>
        
      
    
    <li>Model</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/majianjia/nnom/edit/master/docs/api_model.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="model-apis">Model APIs</h1>
<p>NNoM support <strong>Sequential model</strong> and <strong>Functional model</strong> whitch are similar to Keras. </p>
<p>Model is a minimum runable object in NNoM. </p>
<p>Here list the Model APIs that used for create, compile and run a model. </p>
<hr />
<h2 id="new_model">new_model()</h2>
<pre><code class="C">nnom_model_t *new_model(nnom_model_t *m);
</code></pre>

<p>This method is to create or initiate a model instance. </p>
<p><strong>Arguments</strong></p>
<ul>
<li><strong> m:</strong> the model instance that need to be initiated. If <code>NULL</code> is passed to it, the method will create a new model instance. </li>
</ul>
<p><strong>Return</strong></p>
<ul>
<li>The created or the initiated model instance.</li>
</ul>
<hr />
<h2 id="model_delete">model_delete()</h2>
<pre><code class="C">void model_delete(nnom_model_t *m);  
</code></pre>

<p>Delete and free all the resources created with the model.</p>
<p><strong>Arguments</strong></p>
<ul>
<li><strong> m:</strong> the model instance.</li>
</ul>
<hr />
<h2 id="sequencial_compile">sequencial_compile()</h2>
<pre><code class="C">nnom_status_t sequencial_compile(nnom_model_t *m);
</code></pre>

<p>Compile a sequencial model which is constructed by sequencial construction APIs.</p>
<p><strong>Arguments</strong></p>
<ul>
<li><strong> m:</strong> the model instance for compile.</li>
</ul>
<p><strong>Return</strong></p>
<ul>
<li>Status of compiling. </li>
</ul>
<hr />
<h2 id="model_compile">model_compile()</h2>
<pre><code class="C">nnom_status_t   model_compile(nnom_model_t *m, nnom_layer_t* input, nnom_layer_t* output);
</code></pre>

<p>Compile a functional model which is constructed by functional construction APIs. </p>
<p><strong>Arguments</strong></p>
<ul>
<li><strong> m:</strong> the model instance for compile.</li>
<li><strong> input:</strong> the specified input layer instance.</li>
<li><strong> output:</strong> the specified output layer instance. If left <code>NULL</code>, the all layers will be compile.</li>
</ul>
<p><strong>Return</strong></p>
<ul>
<li>Status of compiling. </li>
</ul>
<hr />
<h2 id="model_run">model_run()</h2>
<pre><code class="C">nnom_status_t   model_run(nnom_model_t *m);
</code></pre>

<p>To run all the layers inside the model. Run one prediction. </p>
<p><strong>Arguments</strong></p>
<ul>
<li><strong> m:</strong> the model instance for compile.</li>
<li><strong> input:</strong> the specified input layer instance.</li>
<li><strong> output:</strong> the specified output layer instance. If left <code>NULL</code>, the all layers will be compile.</li>
</ul>
<p><strong>Return</strong></p>
<ul>
<li>The status of layer running. </li>
</ul>
<p><strong>Note</strong></p>
<p>User must fill in the input buffer which has passed to the input layer before run the model. 
The input layer then copy the data from user space to NNoM memory space to run the model. 
The results of prediction will be copy from NNoM memory space to user memory space by Output layer. </p>
<hr />
<h2 id="model_run_to">model_run_to()</h2>
<pre><code class="C">nnom_status_t model_run_to(nnom_model_t *m, nnom_layer_t *end_layer);
</code></pre>

<p>Same as <code>model_run()</code> but it only run partly to the specified layer. </p>
<p><strong>Arguments</strong></p>
<ul>
<li><strong> m:</strong> the model instance for compile.</li>
<li><strong> end_layer:</strong> the layer where to stop.</li>
</ul>
<p><strong>Return</strong></p>
<ul>
<li>The result of layer running. </li>
</ul>
<hr />
<h2 id="layer_callback">(*layer_callback)()</h2>
<pre><code class="C">nnom_status_t (*layer_callback)(nnom_model_t *m, nnom_layer_t *layer);
</code></pre>

<p>This callback is a runtime callback, which can then be used to evaluate the performance, extract the intermediate output etc. 
It will be called after each layer has ran. (if a actail (activation tail) is present, this callback will be called after the actail)</p>
<p><strong>Arguments</strong></p>
<ul>
<li><strong> m:</strong> the model instance of the current model.</li>
<li><strong> layer:</strong> the layer instance which has just been ran.</li>
</ul>
<p><strong>Return</strong></p>
<ul>
<li>The result of the callback. Any result other than NN_SUCCESS will cause the model to return immediately with the error code.  </li>
</ul>
<p><strong>NOTE</strong></p>
<ul>
<li>
<p>You should not change ANY setting inside the model instance or the layer instance unless you know what you are doing. 
All configurations and buffers must be read-only inside this method. </p>
</li>
<li>
<p>This is a runtime callback which means it will affect your performance if this callback is time consuming. </p>
</li>
</ul>
<hr />
<h2 id="model_set_callback">model_set_callback()</h2>
<pre><code class="C">nnom_status_t model_set_callback(
    nnom_model_t *m, 
    nnom_status_t (*layer_callback)(nnom_model_t *m, nnom_layer_t *layer));
</code></pre>

<p>Set a callback to model. Please refer to the <code>(*layer_callback)()</code>. 
If a callback is already set but not the same one as what is given, this method will return error. 
You need to delete the old callback by <code>model_delete_callback()</code> before setting new callback.</p>
<p><strong>Arguments</strong></p>
<ul>
<li><strong> m:</strong> the model instance to be set.</li>
<li><strong> *layer_callback:</strong> the layer callback.</li>
</ul>
<p><strong>Return</strong></p>
<ul>
<li>NN_SUCCESS: when callback is set successfully</li>
<li>NN_LENGTH_ERROR: when callback is existed in the model but not the same as the given one. </li>
</ul>
<hr />
<h2 id="model_delete_callback">model_delete_callback()</h2>
<pre><code class="C">void model_delete_callback(nnom_model_t *m);
</code></pre>

<p>Delete an existing callback on the model.</p>
<p><strong>Arguments</strong></p>
<ul>
<li><strong> m:</strong> the model instance to delete the callback from.</li>
</ul>
<hr />
<h2 id="examples">Examples</h2>
<p>This example shows a 2 layer MPL for MNIST dateset. Input shape 28 x 28 x 1 hand writing image. 
Please check <a href="https://github.com/majianjia/nnom/tree/master/examples/mnist-densenet">mnist-densenet example</a> for further reading. </p>
<p><strong>Sequential model</strong></p>
<pre><code class="C">
/* nnom model */
int8_t input_data[784];
int8_t output_data[10];
void sequencial_model(void)
{
    nnom_model_t model;

    new_model(&amp;model);

    model.add(&amp;model, Input(shape(784, 1, 1), input_data));
    model.add(&amp;model, Flatten());
    model.add(&amp;model, Dense(100, &amp;w1, &amp;b1));
    model.add(&amp;model, Dense(10, &amp;w2, &amp;b2));
    model.add(&amp;model, Softmax())
    model.add(&amp;model, Output(shape(10, 1, 1), output_data));

    sequencial_compile(&amp;model);

    while(1)
    {
        feed_data(&amp;input_data);
        model_run(&amp;model);

        // evaluate on output_data[]
        ...
    }
}

</code></pre>

<p><strong>Functional model</strong></p>
<pre><code class="C">
/* nnom model */
int8_t input_data[784];
int8_t output_data[10];
void functional_model(void)
{
    static nnom_model_t model;
    nnom_layer_t *input, *x;

    new_model(&amp;model);

    input = Input(shape(784, 1, 1), input_data);
    x = model.hook(Flatten(), input);
    x = model.hook(Dense(100, &amp;w1, &amp;b1), x)
    x = model.hook(Dense(10, &amp;w2, &amp;b2), x)
    x = model.hook(Softmax(), x)
    x = model.hook(Output(shape(10, 1, 1), output_data), x);

    // compile these layers into the model. 
    model_compile(&amp;model, input, x);

    while(1)
    {
        feed_data(&amp;input_data);
        model_run(&amp;model);

        // evaluate on output_data[]
        ...
    }
}

</code></pre>

<p><strong>Layer Callback</strong></p>
<pre><code class="C">
// this callback to print output size of every layer.
nnom_status_t callback(nnom_model_t *m, nnom_layer_t *layer)
{
    printf(&quot;layer %s, output size %d \n&quot;, default_layer_names[layer-&gt;type], shape_size(&amp;layer-&gt;out-&gt;shape));
    return NN_SUCCESS;
}

int main(void)
{
    // using automatic tools to generate model
    model = nnom_model_create();

    // set callback
    model_set_callback(model, callback);

    // run and see what happend.
    model_run(model);
}

</code></pre>

<p>Here is the console logging of the callback output:</p>
<pre><code>layer Input, output shape 784 
layer Conv2D, output shape 9408 
layer MaxPool, output shape 2352 
layer UpSample, output shape 9408 
layer Conv2D, output shape 2352 
layer Conv2D, output shape 9408 
layer Add, output shape 9408 
layer MaxPool, output shape 2352 
layer Conv2D, output shape 2352 
...

</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../api_construction/" class="btn btn-neutral float-right" title="Construction Methods">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../api_nnom/" class="btn btn-neutral" title="Utils (>0.4.0)"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/majianjia/nnom/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../api_nnom/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../api_construction/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
